# 5.0: Creating the Playbook
## Objective
The objective of this section is to create our playbook. If you can remember in section 1.0, I made a diagram of the playbook workflow we are aiming for. We want the playbook to send a Slack message and email containing information about the detection. We also want to generate a user prompt that asks us if we want to isolate the machine. If yes, then the machine will be isolated, and if no, then the prompt will ask us to investigate further without isolating the machine. 

Let's get started! ðŸ˜¸

## Steps
To begin, let's refer back to the diagram we created in section 1.0. So far, we have completed the first two steps of the playbook:
- Send events from the infected machine to LimaCharlie
- Send detections (alerts) from LimaCharlie to Tines

<p align="center"><img src="https://i.imgur.com/oysUHMA.png"></p>
<p align="center"><i>Ref 1: We have completed the first two steps in the playbook.</i></p>
<br><br>

Next, we want Tines to send a message over to Slack. Let's do that! First, we have to add Tines to Slack.

<p align="center"><img src="https://i.imgur.com/7uaObsD.png"></p>
<p align="center"><i>Ref 2: Searching for Tines under Apps in Slack.</i></p>
<br><br>

<p align="center"><img src="https://i.imgur.com/Wuxfrck.png"></p>
<p align="center"><i>Ref 3: We are led to this page after clicking on Add.</i></p>
<br><br>

To do this, we can follow Tine's instructions. We need to log in to Tines, navigate to our "Team," add a `New Credential`, and select Slack. After selecting Slack, we'll be asked to connect our Slack workspace. After that, we will have a new Slack credential that we can use. Essentially, this establishes the link between Tines and Slack.

<p align="center"><img src="https://i.imgur.com/PaqihTU.png"></p>
<p align="center"><i>Ref 4: My Slack credential within Tines.</i></p>
<br><br>

Once I've connected Tines and Slack, I can test the connection by sending a message from Tines to Slack. Heading back to the story, we can use the Slack template in the bottom left corner. On the right, we can look for certain actions. In our case, we want to send a message. We can do that by selecting the action "Send a message." 

<p align="center"><img src="https://i.imgur.com/3JyVSWN.png"></p>
<p align="center"><i>Ref 5: By selecting "Templates," we can find the Slack template. From here, we can use the template to select the action "Send a message."</i></p>
<br><br>

<p align="center"><img src="https://i.imgur.com/Ojfxxrf.png"></p>
<p align="center"><i>Ref 6: Our Slack widget is set to send a message.</i></p>
<br><br>

The Slack widget takes many parameters, like, for example, the channel ID it will broadcast to (send the message to) and the actual message. For right now, we'll set the message to "Hello, World!" Classic. ðŸ˜¼ As a side note, to get the specific channel ID we want to send our message to, we can do that in Slack. By right-clicking the specific channel and navigating a little bit, we can find the channel ID. By clicking "Test," we can test to see if our Slack widget is working as expected. 

<p align="center"><img src="https://i.imgur.com/qaGASUI.png"></p>
<p align="center"><i>Ref 7: We can click "Test" to see if the Slack widget is working as expected.</i></p>
<br><br>

After clicking test, our message is sent to the #alerts channel!

<p align="center"><img src="https://i.imgur.com/Mk24tR9.png"></p>
<p align="center"><i>Ref 8: Our message is sent!</i></p>
<br><br>

Now that we've tested the workflow and it's working as intended, we can start adding the details that we want to the message. Remember, we wanted the message to contain information such as the host IP, the hostname, username, file path, sensor ID, etc. Before we do that, however, let's get started on sending that email we wanted. Not only do we want a Slack message, but we want an email as well.

We can use the email template to create the email action. I'll set it to send to my email, and for the message, we can leave it as the default for the sake of testing.

<p align="center"><img src="https://i.imgur.com/gGXa4Zq.png"></p>
<p align="center"><i>Ref 9: Sending an email using the email template.</i></p>
<br><br>

So far, we have successfully set up the Slack message and the email. Looking at our playbook, we can see that next is creating the user prompt. To create the user prompt, we can use what Tines calls a "Page." A Page is nothing more than a webpage. We'll be using the Page to ask the user if they want to isolate the machine. 

<p align="center"><img src="https://i.imgur.com/mKHCkfL.png"></p>
<p align="center"><i>Ref 10: Setting up the user prompt as a Page in Tines.</i></p>
<br><br>

We'll edit the Page so that it takes a boolean Yes/No in regards to isolating the machine. 

<p align="center"><img src="https://i.imgur.com/8L8HAD3.png"></p>
<p align="center"><i>Ref 11: Editing our Page.</i></p>
<br><br>
                    
If you remember, we wanted to include the detection details in the user prompt, email, and Slack message. Let's try integrating those details into our Page. To do that, we'll have to do a little research first. If we look into the body of the events of our "Retrieve Detections" webhook, we can see lots of interesting details. These fields can be copied and pasted so that they dynamically update depending on which event they correspond to. For example, if we copy the "cat" field, we'll get this: `<<retrieve_detections.body.cat>>`. Effectively, this retrieves the detection details from the body of the event, specifically for the "cat" field. We can use these fields within the bodies of our Slack messages, emails, and user prompts. 

We're essentially pulling the data from our webhook and using it within the bodies of our messages. ðŸ˜„

<p align="center"><img src="https://i.imgur.com/klJjAOz.png"></p>
<p align="center"><i>Ref 12: We're pulling data from our "Retrieve Detections" webhook and using it within the body of our Slack message.</i></p>
<br><br>

<p align="center"><img src="https://i.imgur.com/R7yUz5Q.png"></p>
<p align="center"><i>Ref 13: Tines sends a message within our #alerts Slack channel with all the details we wanted!</i></p>
<br><br>

<p align="center"><img src="https://i.imgur.com/S4RKtVW.png"></p>
<p align="center"><i>Ref 11:</i></p>
<br><br>

<p align="center"><img src="https://i.imgur.com/4nf6xFU.png"></p>
<p align="center"><i>Ref 12:</i></p>
<br><br>

<p align="center"><img src="https://i.imgur.com/wdr9lBc.png"></p>
<p align="center"><i>Ref 13:</i></p>
<br><br>

<p align="center"><img src="https://i.imgur.com/z1JTdOf.png"></p>
<p align="center"><i>Ref 14:</i></p>
<br><br>

<p align="center"><img src="https://i.imgur.com/eetYzPX.png"></p>
<p align="center"><i>Ref 15:</i></p>
<br><br>

<p align="center"><img src="https://i.imgur.com/reESucI.png"></p>
<p align="center"><i>Ref 16:</i></p>
<br><br>




